name: Deploy to IPFS

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: 'false'
        type: boolean
      update_ens:
        description: 'Auto-update ENS content hash'
        required: false
        default: 'false'
        type: boolean
      dry_run:
        description: 'Dry run (build and verify only)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  ENS_NAME: 'bitbrowse.eth'

jobs:
  # Run tests first (unless skipped via manual trigger)
  test:
    name: Pre-deploy Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type check
        run: npm run typecheck

      - name: Run unit tests
        run: npm run test

      - name: Run security tests
        run: npm run test:security || true
        continue-on-error: true

  build:
    name: Build Production Bundle
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    outputs:
      build_hash: ${{ steps.build_info.outputs.hash }}
      bundle_size: ${{ steps.build_info.outputs.size }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for production
        run: npm run build
        env:
          NODE_ENV: production

      - name: Verify build integrity
        run: |
          if [ ! -f dist/index.html ]; then
            echo "::error::Build failed - index.html not found"
            exit 1
          fi

          # Check for required PWA files
          if [ ! -f dist/manifest.webmanifest ]; then
            echo "::warning::manifest.webmanifest not found"
          fi

          # Check for service worker
          if [ ! -f dist/sw.js ]; then
            echo "::warning::Service worker not found"
          fi

      - name: Generate build info
        id: build_info
        run: |
          BUILD_HASH=$(find dist -type f -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)
          echo "hash=${BUILD_HASH:0:16}" >> $GITHUB_OUTPUT
          echo "Build hash: ${BUILD_HASH:0:16}"

          BUNDLE_SIZE=$(du -sh dist/ | cut -f1)
          echo "size=${BUNDLE_SIZE}" >> $GITHUB_OUTPUT
          echo "Bundle size: ${BUNDLE_SIZE}"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/
          retention-days: 30

  deploy-ipfs:
    name: Deploy to IPFS
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event.inputs.dry_run != 'true'
    outputs:
      ipfs_cid: ${{ steps.deploy.outputs.cid }}
      pinata_cid: ${{ steps.pinata.outputs.cid }}
      web3storage_cid: ${{ steps.web3storage.outputs.cid }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/

      - name: Deploy to IPFS via Pinata
        id: pinata
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}
        run: |
          if [ -z "$PINATA_JWT" ]; then
            echo "::warning::PINATA_JWT not set, skipping Pinata upload"
            echo "cid=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Uploading to Pinata..."
          CID=$(npx tsx scripts/deploy-ipfs.ts --pinata 2>&1 | tail -1)

          if [[ "$CID" =~ ^(Qm|bafy) ]]; then
            echo "cid=${CID}" >> $GITHUB_OUTPUT
            echo "Pinata CID: ${CID}"
          else
            echo "::error::Pinata upload failed"
            echo "Output: $CID"
            exit 1
          fi

      - name: Deploy to web3.storage (backup)
        id: web3storage
        env:
          WEB3_STORAGE_TOKEN: ${{ secrets.WEB3_STORAGE_TOKEN }}
        run: |
          if [ -z "$WEB3_STORAGE_TOKEN" ]; then
            echo "::warning::WEB3_STORAGE_TOKEN not set, skipping web3.storage upload"
            echo "cid=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Uploading to web3.storage..."
          CID=$(npx tsx scripts/deploy-ipfs.ts --web3storage 2>&1 | tail -1)

          if [[ "$CID" =~ ^(Qm|bafy) ]]; then
            echo "cid=${CID}" >> $GITHUB_OUTPUT
            echo "web3.storage CID: ${CID}"
          else
            echo "::warning::web3.storage upload may have failed"
            echo "cid=" >> $GITHUB_OUTPUT
          fi

      - name: Set primary CID
        id: deploy
        run: |
          PINATA_CID="${{ steps.pinata.outputs.cid }}"
          WEB3_CID="${{ steps.web3storage.outputs.cid }}"

          # Use Pinata CID as primary, fall back to web3.storage
          if [ -n "$PINATA_CID" ]; then
            echo "cid=${PINATA_CID}" >> $GITHUB_OUTPUT
            echo "Primary CID (Pinata): ${PINATA_CID}"
          elif [ -n "$WEB3_CID" ]; then
            echo "cid=${WEB3_CID}" >> $GITHUB_OUTPUT
            echo "Primary CID (web3.storage): ${WEB3_CID}"
          else
            echo "::error::No IPFS deployment succeeded"
            exit 1
          fi

      - name: Verify CID consistency
        if: steps.pinata.outputs.cid != '' && steps.web3storage.outputs.cid != ''
        run: |
          PINATA_CID="${{ steps.pinata.outputs.cid }}"
          WEB3_CID="${{ steps.web3storage.outputs.cid }}"

          if [ "$PINATA_CID" != "$WEB3_CID" ]; then
            echo "::warning::CIDs from different providers do not match"
            echo "Pinata: ${PINATA_CID}"
            echo "web3.storage: ${WEB3_CID}"
          else
            echo "CIDs match across providers: ${PINATA_CID}"
          fi

  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-ipfs]
    steps:
      - name: Wait for IPFS propagation
        run: sleep 30

      - name: Verify via multiple gateways
        run: |
          CID="${{ needs.deploy-ipfs.outputs.ipfs_cid }}"
          if [ -z "$CID" ]; then
            echo "::warning::No CID to verify"
            exit 0
          fi

          echo "Verifying CID: ${CID}"

          GATEWAYS=(
            "https://${CID}.ipfs.dweb.link"
            "https://${CID}.ipfs.cf-ipfs.com"
            "https://gateway.pinata.cloud/ipfs/${CID}"
            "https://ipfs.io/ipfs/${CID}"
            "https://cloudflare-ipfs.com/ipfs/${CID}"
          )

          SUCCESS_COUNT=0
          for GATEWAY in "${GATEWAYS[@]}"; do
            echo "Checking: ${GATEWAY}"
            if curl -sf -o /dev/null --connect-timeout 30 --max-time 60 "${GATEWAY}"; then
              echo "  ✓ Gateway accessible"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "  ✗ Gateway not responding"
            fi
          done

          echo ""
          echo "Accessible gateways: ${SUCCESS_COUNT}/${#GATEWAYS[@]}"

          if [ $SUCCESS_COUNT -eq 0 ]; then
            echo "::warning::Content not yet accessible via any gateway (may still be propagating)"
          fi

      - name: Check index.html content
        run: |
          CID="${{ needs.deploy-ipfs.outputs.ipfs_cid }}"
          if [ -z "$CID" ]; then
            exit 0
          fi

          # Try to fetch and verify index.html
          GATEWAY="https://gateway.pinata.cloud/ipfs/${CID}"
          echo "Fetching index.html from ${GATEWAY}..."

          if curl -sf --max-time 60 "${GATEWAY}" | grep -q "BitChat"; then
            echo "✓ Content verified - BitChat found in index.html"
          else
            echo "::warning::Could not verify BitChat content in index.html"
          fi

  update-ens:
    name: Update ENS Content Hash
    runs-on: ubuntu-latest
    needs: [deploy-ipfs, verify]
    if: |
      github.event.inputs.update_ens == 'true' &&
      needs.deploy-ipfs.outputs.ipfs_cid != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci && npm install ethers@^6.0.0

      - name: Update ENS content hash
        env:
          ENS_PRIVATE_KEY: ${{ secrets.ENS_PRIVATE_KEY }}
          RPC_URL: ${{ secrets.ETH_RPC_URL }}
        run: |
          CID="${{ needs.deploy-ipfs.outputs.ipfs_cid }}"

          if [ -z "$ENS_PRIVATE_KEY" ]; then
            echo "::error::ENS_PRIVATE_KEY secret not set"
            echo "To enable automatic ENS updates, add the ENS_PRIVATE_KEY secret"
            exit 1
          fi

          echo "Updating ENS content hash for ${{ env.ENS_NAME }}..."
          echo "New CID: ${CID}"

          npx tsx scripts/update-ens.ts "${CID}" --update

      - name: Verify ENS resolution
        run: |
          echo "Waiting for ENS update to propagate..."
          sleep 60

          echo "Verifying https://${{ env.ENS_NAME }}.limo..."
          if curl -sf -o /dev/null --max-time 120 "https://bitbrowse.eth.limo"; then
            echo "✓ ENS resolution verified"
          else
            echo "::warning::ENS may still be propagating"
          fi

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build, deploy-ipfs, verify]
    if: always()
    steps:
      - name: Create Job Summary
        run: |
          CID="${{ needs.deploy-ipfs.outputs.ipfs_cid }}"
          PINATA_CID="${{ needs.deploy-ipfs.outputs.pinata_cid }}"
          WEB3_CID="${{ needs.deploy-ipfs.outputs.web3storage_cid }}"
          BUILD_HASH="${{ needs.build.outputs.build_hash }}"
          BUNDLE_SIZE="${{ needs.build.outputs.bundle_size }}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          # BitChat In Browser - Deployment Summary

          ## Build Information
          | Property | Value |
          |----------|-------|
          | Commit | \`${{ github.sha }}\` |
          | Branch | \`${{ github.ref_name }}\` |
          | Build Hash | \`${BUILD_HASH:-N/A}\` |
          | Bundle Size | ${BUNDLE_SIZE:-N/A} |
          | Timestamp | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |

          EOF

          if [ -n "$CID" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF

          ## IPFS Deployment

          **Primary CID:** \`${CID}\`

          ### Gateway URLs
          - [dweb.link](https://${CID}.ipfs.dweb.link)
          - [cf-ipfs.com](https://${CID}.ipfs.cf-ipfs.com)
          - [Pinata Gateway](https://gateway.pinata.cloud/ipfs/${CID})
          - [ipfs.io](https://ipfs.io/ipfs/${CID})
          - [Cloudflare](https://cloudflare-ipfs.com/ipfs/${CID})

          ### Upload Status
          EOF

            if [ -n "$PINATA_CID" ]; then
              echo "- Pinata: Uploaded (\`${PINATA_CID}\`)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Pinata: Skipped (no credentials)" >> $GITHUB_STEP_SUMMARY
            fi

            if [ -n "$WEB3_CID" ]; then
              echo "- web3.storage: Uploaded (\`${WEB3_CID}\`)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- web3.storage: Skipped (no credentials)" >> $GITHUB_STEP_SUMMARY
            fi

            cat >> $GITHUB_STEP_SUMMARY << EOF

          ## ENS Update Instructions

          To update the ENS content hash for \`${{ env.ENS_NAME }}\`:

          ### Option 1: ENS Manager App (Recommended)
          1. Go to [app.ens.domains](https://app.ens.domains)
          2. Connect wallet that owns \`${{ env.ENS_NAME }}\`
          3. Go to **${{ env.ENS_NAME }}** -> **Records**
          4. Edit **Content Hash**
          5. Set to: \`ipfs://${CID}\`
          6. Confirm transaction
          7. Verify at [${{ env.ENS_NAME }}.limo](https://bitbrowse.eth.limo)

          ### Option 2: Automatic Update
          Run this workflow with \`update_ens: true\` after configuring:
          - \`ENS_PRIVATE_KEY\` - Private key of wallet owning the ENS name
          - \`ETH_RPC_URL\` - Ethereum mainnet RPC URL (optional)

          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF

          ## Deployment Status

          **Deployment failed or was skipped**

          Please check the workflow logs and ensure the following secrets are configured:
          - \`PINATA_JWT\` - JWT token for Pinata API
          - \`WEB3_STORAGE_TOKEN\` - Token for web3.storage API

          EOF
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF

          ---
          *Generated by BitChat deployment workflow*
          EOF

      - name: Post to Slack (optional)
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          CID="${{ needs.deploy-ipfs.outputs.ipfs_cid }}"

          if [ -n "$CID" ] && [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"BitChat deployed to IPFS\nCID: \`${CID}\`\nGateway: https://${CID}.ipfs.dweb.link\"}" \
              "$SLACK_WEBHOOK_URL" || true
          fi
